---
- name: Pentest | Set Postgres to start upon system boot
  ansible.builtin.service:
    name: postgresql
    enabled: true
  # Don't bother with systemd in the Molecule Docker container. Just skip testing this task.
  tags: notest

- name: Pentest | Initialize MSFDB
  ansible.builtin.shell:
    cmd: msfdb init && touch ~/.ansible-msfdb-init
    creates: ~/.ansible-msfdb-init
  # Don't bother with systemd in the Molecule Docker container.
  # Can't connect to Postgresl due to systemd in Docker. Not a big testing concern.
  tags: notest

- name: Pentest | Create wordlists dir
  ansible.builtin.file:
    path: /usr/share/wordlists
    state: directory
    mode: '755'

- name: Pentest | Un-archive Rockyou Wordlist
  ansible.builtin.unarchive:
    remote_src: true
    src: /usr/share/seclists/Passwords/Leaked-Databases/rockyou.txt.tar.gz
    dest: /usr/share/wordlists
    mode: '666'

- name: Pentest | Install Autorecon
  ansible.builtin.command:
    cmd: python3 -m pip install git+https://github.com/Tib3rius/AutoRecon.git
    creates: /usr/local/bin/autorecon

- name: Pentest | Download PEDA
  ansible.builtin.git:
    repo: https://github.com/longld/peda.git
    dest: /peda
    version: master
    bare: true

- name: Pentest | Update PEDA file permissions
  ansible.builtin.file:
    path: /peda
    owner: '{{ ansible_user }}'
    group: '{{ ansible_user }}'
    recurse: true
    state: directory
    mode: '755'

- name: Pentest | Configure PEDA
  ansible.builtin.lineinfile:
    path: "{{ item }}/.gdbinit"
    line: source /peda/peda.py
    create: true
    state: present
    regexp: ^source .*\/peda\.py$
    mode: '660'
  loop:
    - /root
    - /home/kali

- name: Pentest | Get Rustscan version
  ansible.builtin.set_fact:
    rustscan_version: "{{ lookup('artis3n.github.latest_release', 'rustscan/rustscan') }}"

- name: Pentest | Install Rustscan
  ansible.builtin.apt:
    deb: https://github.com/RustScan/RustScan/releases/download/{{ rustscan_version }}/rustscan_{{ rustscan_version }}_amd64.deb
